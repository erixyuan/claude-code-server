# API è¯·æ±‚æ—¥å¿—ç¤ºä¾‹

ç°åœ¨æ‰€æœ‰ API ç«¯ç‚¹éƒ½ä¼šåœ¨å…¥å£å¤„æ‰“å°è¯¦ç»†çš„è¯·æ±‚å‚æ•°æ—¥å¿—ã€‚

## /chat ç«¯ç‚¹ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰

### è¯·æ±‚
```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±",
    "user_id": "user123"
  }'
```

### æ—¥å¿—è¾“å‡º
```
================================================================================
ğŸ“¨ æ”¶åˆ° /chat è¯·æ±‚ (sync mode)
================================================================================
ğŸ‘¤ User ID: user123
ğŸ”‘ Session ID: user_user123 (é»˜è®¤)
ğŸ“ Message: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
ğŸ“ Message Length: 12 å­—ç¬¦
âš™ï¸  Response Mode: sync (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
================================================================================
```

---

## /chat/stream ç«¯ç‚¹ï¼ˆæµå¼æ¨¡å¼ï¼‰

### è¯·æ±‚
```bash
curl -X POST http://localhost:8000/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "å†™ä¸€ä¸ª Python å‡½æ•°",
    "user_id": "user456",
    "session_id": "custom_session_1"
  }'
```

### æ—¥å¿—è¾“å‡º
```
================================================================================
ğŸ“¨ æ”¶åˆ° /chat/stream è¯·æ±‚ (stream mode)
================================================================================
ğŸ‘¤ User ID: user456
ğŸ”‘ Session ID: custom_session_1 (é»˜è®¤)
ğŸ“ Message: å†™ä¸€ä¸ª Python å‡½æ•°
ğŸ“ Message Length: 9 å­—ç¬¦
âš™ï¸  Response Mode: stream (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
================================================================================
```

---

## /chat/async ç«¯ç‚¹ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰- æ— é˜²æŠ–

### è¯·æ±‚
```bash
curl -X POST http://localhost:8000/chat/async \
  -H "Content-Type: application/json" \
  -d '{
    "message": "å¸®æˆ‘åˆ†æä»£ç ",
    "user_id": "user789",
    "enable_debounce": false
  }'
```

### æ—¥å¿—è¾“å‡º
```
================================================================================
ğŸ“¨ æ”¶åˆ° /chat/async è¯·æ±‚ (async mode)
================================================================================
ğŸ‘¤ User ID: user789
ğŸ”‘ Session ID: user_user789 (é»˜è®¤)
ğŸ“ Message: å¸®æˆ‘åˆ†æä»£ç 
ğŸ“ Message Length: 7 å­—ç¬¦
âš™ï¸  Response Mode: async (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
ğŸ”„ Debounce Enabled: False
ğŸš€ ç«‹å³åˆ›å»ºä»»åŠ¡ï¼ˆé˜²æŠ–å·²ç¦ç”¨ï¼‰
================================================================================
ğŸ¯ åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
================================================================================
ğŸ“‹ Task ID: 550e8400-e29b-41d4-a716-446655440000
ğŸ‘¤ User ID: user789
ğŸ”‘ Session ID: user_user789
ğŸ“ æ¶ˆæ¯å†…å®¹: å¸®æˆ‘åˆ†æä»£ç 
ğŸ“ æ¶ˆæ¯é•¿åº¦: 7 å­—ç¬¦
================================================================================
âœ… ä»»åŠ¡å·²åˆ›å»º: 550e8400-e29b-41d4-a716-446655440000
```

---

## /chat/async ç«¯ç‚¹ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰- å¯ç”¨é˜²æŠ–

### è¯·æ±‚
```bash
curl -X POST http://localhost:8000/chat/async \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½",
    "user_id": "user999",
    "enable_debounce": true,
    "debounce_window": 3.0
  }'
```

### æ—¥å¿—è¾“å‡º
```
================================================================================
ğŸ“¨ æ”¶åˆ° /chat/async è¯·æ±‚ (async mode)
================================================================================
ğŸ‘¤ User ID: user999
ğŸ”‘ Session ID: user_user999 (é»˜è®¤)
ğŸ“ Message: ä½ å¥½
ğŸ“ Message Length: 2 å­—ç¬¦
âš™ï¸  Response Mode: async (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
ğŸ”„ Debounce Enabled: True
â° Debounce Window: 3.0s
ğŸ“® æ¶ˆæ¯å°†è¢«ç¼“å†²ï¼Œç­‰å¾…æ›´å¤šæ¶ˆæ¯...
================================================================================
2025-11-16 14:20:00 | INFO     | claude_code_server_api.message_buffer:add_message:92 - ğŸ“ Message buffered for session user_user999: 'ä½ å¥½...' (total: 1 messages)
2025-11-16 14:20:00 | DEBUG    | claude_code_server_api.message_buffer:add_message:106 - â±ï¸  Started 3.0s debounce timer for session user_user999
```

### 3ç§’åæ”¶åˆ°ç¬¬äºŒæ¡æ¶ˆæ¯
```bash
curl -X POST http://localhost:8000/chat/async \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ æ˜¯è°",
    "user_id": "user999",
    "enable_debounce": true,
    "debounce_window": 3.0
  }'
```

### æ—¥å¿—è¾“å‡º
```
================================================================================
ğŸ“¨ æ”¶åˆ° /chat/async è¯·æ±‚ (async mode)
================================================================================
ğŸ‘¤ User ID: user999
ğŸ”‘ Session ID: user_user999 (é»˜è®¤)
ğŸ“ Message: ä½ æ˜¯è°
ğŸ“ Message Length: 3 å­—ç¬¦
âš™ï¸  Response Mode: async (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
ğŸ”„ Debounce Enabled: True
â° Debounce Window: 3.0s
ğŸ“® æ¶ˆæ¯å°†è¢«ç¼“å†²ï¼Œç­‰å¾…æ›´å¤šæ¶ˆæ¯...
================================================================================
2025-11-16 14:20:01 | INFO     | claude_code_server_api.message_buffer:add_message:92 - ğŸ“ Message buffered for session user_user999: 'ä½ æ˜¯è°...' (total: 2 messages)
2025-11-16 14:20:01 | DEBUG    | claude_code_server_api.message_buffer:add_message:100 - â±ï¸  Cancelled existing timer for session user_user999
2025-11-16 14:20:01 | DEBUG    | claude_code_server_api.message_buffer:add_message:106 - â±ï¸  Started 3.0s debounce timer for session user_user999
```

### 3ç§’åè®¡æ—¶å™¨åˆ°æœŸï¼Œåˆå¹¶æ¶ˆæ¯
```
2025-11-16 14:20:04 | INFO     | claude_code_server_api.message_buffer:_flush:166 - ğŸ”„ Flushing 2 message(s) for session user_user999
2025-11-16 14:20:04 | DEBUG    | claude_code_server_api.message_buffer:_flush:169 -    Combined message: 'ä½ å¥½
ä½ æ˜¯è°...'
================================================================================
ğŸ¯ åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
================================================================================
ğŸ“‹ Task ID: abc123-def4-56gh-7890-ijklmnopqrst
ğŸ‘¤ User ID: user999
ğŸ”‘ Session ID: user_user999
ğŸ“ æ¶ˆæ¯å†…å®¹: ä½ å¥½
ä½ æ˜¯è°
ğŸ“ æ¶ˆæ¯é•¿åº¦: 6 å­—ç¬¦
ğŸ”„ æ£€æµ‹åˆ°åˆå¹¶æ¶ˆæ¯ï¼ŒåŒ…å« 2 éƒ¨åˆ†:
   1. ä½ å¥½
   2. ä½ æ˜¯è°
================================================================================
ğŸš€ Created task abc123-def4-56gh-7890-ijklmnopqrst with combined message for session user_user999
```

---

## å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹æ—¥å¿—

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä»å…¥å£åˆ° Claude SDK è°ƒç”¨çš„æ—¥å¿—ç¤ºä¾‹ï¼š

```
# ===== 1. API ç«¯ç‚¹å…¥å£ =====
================================================================================
ğŸ“¨ æ”¶åˆ° /chat/async è¯·æ±‚ (async mode)
================================================================================
ğŸ‘¤ User ID: user123
ğŸ”‘ Session ID: user_user123 (é»˜è®¤)
ğŸ“ Message: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
ğŸ“ Message Length: 12 å­—ç¬¦
âš™ï¸  Response Mode: async (é»˜è®¤)
â±ï¸  Timeout: 300 ç§’
ğŸ”„ Debounce Enabled: False
ğŸš€ ç«‹å³åˆ›å»ºä»»åŠ¡ï¼ˆé˜²æŠ–å·²ç¦ç”¨ï¼‰
================================================================================

# ===== 2. TaskManager åˆ›å»ºä»»åŠ¡ =====
================================================================================
ğŸ¯ åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
================================================================================
ğŸ“‹ Task ID: 550e8400-e29b-41d4-a716-446655440000
ğŸ‘¤ User ID: user123
ğŸ”‘ Session ID: user_user123
ğŸ“ æ¶ˆæ¯å†…å®¹: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
ğŸ“ æ¶ˆæ¯é•¿åº¦: 12 å­—ç¬¦
================================================================================
âœ… ä»»åŠ¡å·²åˆ›å»º: 550e8400-e29b-41d4-a716-446655440000

# ===== 3. ä»»åŠ¡å¼€å§‹æ‰§è¡Œ =====
â–¶ï¸  å¼€å§‹æ‰§è¡Œä»»åŠ¡ 550e8400-e29b-41d4-a716-446655440000

# ===== 4. Agent æ”¶åˆ°æ¶ˆæ¯ =====
================================================================================
ğŸ“¥ Agent æ”¶åˆ°æ¶ˆæ¯
================================================================================
ğŸ‘¤ User ID: user123
ğŸ”‘ Session ID: user_user123
ğŸ“ åŸå§‹æ¶ˆæ¯: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
âœï¸  æ ¼å¼åŒ–å: ä»¥ä¸‹æ˜¯user_id=user123å‘è¿‡æ¥çš„é£ä¹¦æ¶ˆæ¯: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
ğŸ“¤ å‘é€ç»™ Claude Client...

# ===== 5. Claude Client è°ƒç”¨ SDK =====
================================================================================
ğŸš€ è°ƒç”¨ Claude Agent SDK
================================================================================
ğŸ“ ç”¨æˆ· Query: ä»¥ä¸‹æ˜¯user_id=user123å‘è¿‡æ¥çš„é£ä¹¦æ¶ˆæ¯: ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
ğŸ”‘ Claude Session ID: æ–°ä¼šè¯
ğŸ“‚ å·¥ä½œç›®å½•: /Users/ericyuan/Project/viralt/viralt-pocket-manager-cc
âš™ï¸  é…ç½®é€‰é¡¹: model=claude-sonnet-4-5-20250929, timeout=300s
â³ ç­‰å¾… Claude å“åº”...

# ===== 6. Claude å“åº”å®Œæˆ =====
âœ… Claude å“åº”å®Œæˆï¼Œå†…å®¹é•¿åº¦: 245 å­—ç¬¦
================================================================================
ğŸ’¾ å·²ä¿å­˜å¯¹è¯å†å²
âœ… Agent å¤„ç†å®Œæˆ
================================================================================

# ===== 7. ä»»åŠ¡å®Œæˆ =====
âœ… ä»»åŠ¡ 550e8400-e29b-41d4-a716-446655440000 æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: 3.45s
```

---

## æ—¥å¿—å…³é”®æ ‡è¯†

| Emoji | å«ä¹‰ | ä½ç½® |
|-------|------|------|
| ğŸ“¨ | æ”¶åˆ° API è¯·æ±‚ | API ç«¯ç‚¹å…¥å£ |
| ğŸ‘¤ | ç”¨æˆ· ID | è¯·æ±‚å‚æ•° |
| ğŸ”‘ | Session ID | è¯·æ±‚å‚æ•° |
| ğŸ“ | æ¶ˆæ¯å†…å®¹ | è¯·æ±‚å‚æ•°/å¤„ç†è¿‡ç¨‹ |
| ğŸ“ | æ¶ˆæ¯é•¿åº¦ | è¯·æ±‚å‚æ•° |
| âš™ï¸ | å“åº”æ¨¡å¼ | è¯·æ±‚å‚æ•° |
| â±ï¸ | è¶…æ—¶æ—¶é—´ | è¯·æ±‚å‚æ•° |
| ğŸ”„ | é˜²æŠ–çŠ¶æ€ | è¯·æ±‚å‚æ•°/å¤„ç†é€»è¾‘ |
| â° | é˜²æŠ–çª—å£ | é˜²æŠ–é…ç½® |
| ğŸ“® | æ¶ˆæ¯ç¼“å†² | é˜²æŠ–é€»è¾‘ |
| ğŸš€ | åˆ›å»ºä»»åŠ¡/è°ƒç”¨ SDK | ä»»åŠ¡ç®¡ç†/SDK è°ƒç”¨ |
| ğŸ¯ | åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ | TaskManager |
| ğŸ“‹ | Task ID | ä»»åŠ¡æ ‡è¯† |
| â–¶ï¸ | å¼€å§‹æ‰§è¡Œ | ä»»åŠ¡æ‰§è¡Œ |
| ğŸ“¥ | Agent æ”¶åˆ°æ¶ˆæ¯ | Agent å±‚ |
| âœï¸ | æ¶ˆæ¯æ ¼å¼åŒ– | æ¶ˆæ¯å¤„ç† |
| ğŸ“¤ | å‘é€ç»™ Client | Agent â†’ Client |
| ğŸ“‚ | å·¥ä½œç›®å½• | SDK é…ç½® |
| âœ… | æˆåŠŸ | å„ä¸ªé˜¶æ®µå®Œæˆ |
| âŒ | é”™è¯¯ | å¼‚å¸¸å¤„ç† |
| ğŸ’¾ | ä¿å­˜æ•°æ® | æŒä¹…åŒ–æ“ä½œ |

---

## å®æ—¶æŸ¥çœ‹è¯·æ±‚æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰è¯·æ±‚
tail -f logs/app_2025-11-16.log | grep "æ”¶åˆ°.*è¯·æ±‚"

# æŸ¥çœ‹ç‰¹å®šç«¯ç‚¹
tail -f logs/app_2025-11-16.log | grep "/chat/async"

# æŸ¥çœ‹ç”¨æˆ·çš„è¯·æ±‚
tail -f logs/app_2025-11-16.log | grep "User ID: user123"

# æŸ¥çœ‹æ‰€æœ‰æ¶ˆæ¯å†…å®¹
tail -f logs/app_2025-11-16.log | grep "ğŸ“ Message:"

# æŸ¥çœ‹å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹
tail -f logs/app_2025-11-16.log | grep -E "æ”¶åˆ°.*è¯·æ±‚|åˆ›å»ºå¼‚æ­¥ä»»åŠ¡|Agent æ”¶åˆ°|è°ƒç”¨.*SDK|å“åº”å®Œæˆ"
```

---

## æ—¥å¿—çº§åˆ«æ§åˆ¶

åœ¨ `config.yaml` ä¸­å¯ä»¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```yaml
logging:
  level: "INFO"   # æ˜¾ç¤ºæ‰€æœ‰ INFO åŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—
  # level: "DEBUG"  # æ˜¾ç¤ºæ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
```

**INFO çº§åˆ«**ï¼šæ˜¾ç¤ºæ‰€æœ‰è¯·æ±‚å‚æ•°å’Œå…³é”®æ­¥éª¤
**DEBUG çº§åˆ«**ï¼šé¢å¤–æ˜¾ç¤º SDK å†…éƒ¨æ¶ˆæ¯ã€è®¡æ—¶å™¨çŠ¶æ€ç­‰è¯¦ç»†ä¿¡æ¯
